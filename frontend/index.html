<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Emerald Password Share</title>
<style>
/* â”€â”€ Reset & Base â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  /* Brand palette */
  --navy:        #22242f;
  --navy-mid:    #2a2d3a;
  --navy-light:  #323648;
  --navy-dim:    #1c1e27;
  --forest:      #49974a;
  --forest-dim:  #2d5e2e;
  --forest-glow: rgba(73,151,74,0.15);
  --lime:        #aad052;
  --lime-dim:    rgba(170,208,82,0.15);
  --off-white:   #fdfeff;

  /* Semantic aliases (dark theme on navy base) */
  --c0: var(--navy);           /* page bg */
  --c1: var(--navy-mid);       /* slightly lighter */
  --c2: var(--navy-light);     /* card/input bg */
  --c3: #3a3d4f;               /* border subtle */
  --c4: #454859;               /* border normal */
  --c5: #565a70;               /* border hover */

  --t0: var(--off-white);      /* primary text */
  --t1: #c8cce0;               /* secondary text */
  --t2: #7a80a0;               /* muted text */

  --green:       var(--forest);
  --green-dim:   var(--forest-dim);
  --green-glow:  var(--forest-glow);
  --accent:      var(--lime);
  --accent-dim:  var(--lime-dim);

  --red:     hsl(0,68%,55%);
  --red-dim:  hsl(0,50%,15%);

  --mono:'Fira Code','Cascadia Code','JetBrains Mono','Courier New',monospace;
  --sans:system-ui,-apple-system,sans-serif;
  --radius:3px;
  --ease:cubic-bezier(0.4,0,0.2,1);
  --t:150ms;
}
html{font-size:15px;-webkit-text-size-adjust:100%}
body{
  font-family:var(--mono);
  background:var(--c0);
  color:var(--t0);
  min-height:100dvh;
  line-height:1.6;
  -webkit-font-smoothing:antialiased;
  /* subtle navy gradient */
  background-image: linear-gradient(160deg, #22242f 0%, #2a2d3a 60%, #22242f 100%);
}

/* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#root{
  min-height:100dvh;
  display:grid;
  grid-template-rows:auto 1fr auto;
}
.wrap{width:100%;max-width:560px;margin:0 auto;padding:0 1.25rem}

/* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
header{
  padding:2rem 0 1.5rem;
  text-align:center;
  border-bottom:1px solid var(--c3);
  background: linear-gradient(180deg, rgba(20,21,28,0.6) 0%, transparent 100%);
}
.logo-img{max-height:56px;max-width:100%;object-fit:contain;display:block;margin:0 auto}
.logo-text{
  font-size:1.05rem;font-weight:500;letter-spacing:0.12em;
  color:var(--lime);text-transform:uppercase;
}
.logo-text em{color:var(--t1);font-style:normal}

/* â”€â”€ Main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
main{padding:2rem 0 4rem}

/* â”€â”€ Footer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
footer{
  border-top:1px solid var(--c3);
  padding:1rem 0;
  text-align:center;
  font-size:0.72rem;
  color:var(--t2);
}

/* â”€â”€ Typography â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.label{
  display:block;
  font-size:0.68rem;
  letter-spacing:0.12em;
  text-transform:uppercase;
  color:var(--t2);
  margin-bottom:0.35rem;
}
.hint{font-size:0.75rem;color:var(--t2);line-height:1.5;margin-bottom:1rem}
.error{color:var(--red);font-size:0.78rem;margin-top:0.4rem}
.warning{
  background:var(--red-dim);
  border:1px solid var(--red);
  padding:0.6rem 0.8rem;
  font-size:0.78rem;
  color:#ffaaaa;
  margin-bottom:1.2rem;
  border-radius:var(--radius);
}
.warning strong{color:#ff8888}
.info-box{
  background:rgba(73,151,74,0.08);
  border:1px solid var(--c4);
  border-left:3px solid var(--forest);
  padding:0.6rem 0.8rem;
  font-size:0.78rem;
  color:var(--t1);
  margin-bottom:1.2rem;
  border-radius:var(--radius);
}

/* â”€â”€ Inputs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
input,textarea{
  width:100%;
  background:rgba(42,45,58,0.8);
  border:1px solid var(--c4);
  color:var(--t0);
  font-family:var(--mono);
  font-size:0.87rem;
  padding:0.6rem 0.75rem;
  outline:none;
  border-radius:var(--radius);
  transition:border-color var(--t) var(--ease), box-shadow var(--t) var(--ease);
  -webkit-appearance:none;
  appearance:none;
}
input:focus,textarea:focus{
  border-color:var(--lime);
  box-shadow:0 0 0 2px var(--lime-dim);
}
input[readonly]{color:var(--t1);cursor:text}
input[type=number]{-moz-appearance:textfield}
input[type=number]::-webkit-inner-spin-button{-webkit-appearance:none}
textarea{
  resize:vertical;
  min-height:clamp(140px,30vh,260px);
  line-height:1.65;
}
.input-row{display:flex;gap:0.5rem;align-items:stretch}
.input-row input{flex:1}

/* â”€â”€ Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
button{font-family:var(--mono);border-radius:var(--radius);cursor:pointer;transition:all var(--t) var(--ease);font-size:0.85rem;border:none}
.btn-primary{
  background: linear-gradient(135deg, var(--forest) 0%, #5aad5b 100%);
  color:#fff;
  font-weight:600;
  padding:0.6rem 1.4rem;
  letter-spacing:0.04em;
  box-shadow:0 2px 8px rgba(73,151,74,0.3);
}
.btn-primary:hover{
  background: linear-gradient(135deg, #5aad5b 0%, var(--lime) 100%);
  color:var(--navy);
  box-shadow:0 4px 16px rgba(170,208,82,0.35);
  transform:translateY(-1px);
}
.btn-primary:active{transform:translateY(1px);box-shadow:none}
.btn-primary:disabled{opacity:0.4;pointer-events:none;transform:none}
.btn-outline{
  background:transparent;
  border:1px solid var(--c5);
  color:var(--t1);
  padding:0.55rem 1rem;
}
.btn-outline:hover{
  border-color:var(--lime);
  color:var(--lime);
  box-shadow:0 0 0 1px var(--lime-dim);
}
.btn-ghost{
  background:transparent;
  border:1px solid var(--c4);
  color:var(--t2);
  padding:0.5rem 0.8rem;
  font-size:0.78rem;
}
.btn-ghost:hover{border-color:var(--t1);color:var(--t1)}
.btn-icon{
  background:var(--navy-light);
  border:1px solid var(--c4);
  color:var(--t1);
  padding:0 0.75rem;
  white-space:nowrap;
  height:100%;
}
.btn-icon:hover{
  border-color:var(--lime);
  color:var(--lime);
  background:rgba(170,208,82,0.1);
}

/* â”€â”€ Pill toggle (text/file) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.mode-toggle{
  display:inline-flex;
  background:rgba(42,45,58,0.8);
  border:1px solid var(--c4);
  border-radius:4px;
  padding:2px;
  gap:2px;
  margin-bottom:1.25rem;
}
.mode-btn{
  background:transparent;border:none;
  padding:0.3rem 1rem;font-size:0.78rem;letter-spacing:0.06em;text-transform:uppercase;
  color:var(--t2);border-radius:3px;
  transition:all var(--t) var(--ease);
}
.mode-btn.active{
  background: linear-gradient(135deg, var(--forest) 0%, #5aad5b 100%);
  color:#fff;
}

/* â”€â”€ Toggle switch â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.toggle-row{
  display:flex;align-items:center;gap:0.6rem;
  font-size:0.8rem;color:var(--t1);cursor:pointer;user-select:none;
}
.sw{
  width:34px;height:18px;flex-shrink:0;
  background:var(--c4);border-radius:9px;
  position:relative;transition:background var(--t) var(--ease);
}
.sw::after{
  content:'';position:absolute;
  top:3px;left:3px;width:12px;height:12px;
  background:var(--t2);border-radius:50%;
  transition:all var(--t) var(--ease);
}
.sw.on{background:var(--forest-dim)}
.sw.on::after{background:var(--lime);left:19px;box-shadow:0 0 4px rgba(170,208,82,0.5)}

/* â”€â”€ Field group â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.field{margin-bottom:1.1rem}
.field:last-child{margin-bottom:0}
.row-2{display:grid;grid-template-columns:1fr 1fr;gap:0.75rem}

/* â”€â”€ File drop zone â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.dropzone{
  border:1px dashed var(--c5);
  border-radius:var(--radius);
  padding:2rem;
  text-align:center;
  cursor:pointer;
  transition:all var(--t) var(--ease);
  background:rgba(42,45,58,0.5);
  min-height:120px;
  display:flex;flex-direction:column;align-items:center;justify-content:center;gap:0.5rem;
}
.dropzone:hover,.dropzone.dragover{
  border-color:var(--lime);
  background:var(--lime-dim);
  box-shadow:0 0 0 2px rgba(170,208,82,0.15);
}
.dropzone-icon{font-size:1.8rem;opacity:0.4}
.dropzone-label{font-size:0.8rem;color:var(--t2)}
.file-list{list-style:none;margin-top:0.8rem;width:100%;text-align:left}
.file-list li{
  display:flex;justify-content:space-between;align-items:center;
  padding:0.35rem 0.5rem;font-size:0.78rem;
  background:var(--navy-mid);border-radius:2px;margin-bottom:3px;
  border:1px solid var(--c3);
}
.file-list li span{color:var(--t2);font-size:0.72rem}

/* â”€â”€ Advanced section â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.advanced{
  border-top:1px solid var(--c3);
  margin-top:1.2rem;
  padding-top:1.2rem;
  display:none;
}
.advanced.open{display:block}

/* â”€â”€ Bottom bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.bottom-bar{
  display:flex;align-items:center;justify-content:space-between;
  margin-top:1rem;flex-wrap:wrap;gap:0.6rem;
}
.bottom-bar-left{display:flex;align-items:center;gap:1rem;flex-wrap:wrap}
.max-label{font-size:0.72rem;color:var(--t2)}
.status-msg{font-size:0.78rem;color:var(--t2);margin-top:0.6rem;min-height:1.2rem}

/* â”€â”€ Note result display â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.note-box{
  background:rgba(42,45,58,0.8);
  border:1px solid var(--c4);
  border-radius:var(--radius);
  padding:1rem;
  white-space:pre-wrap;
  word-break:break-word;
  font-size:0.85rem;
  line-height:1.7;
  max-height:320px;
  overflow-y:auto;
  margin-bottom:0.8rem;
}
.file-dl-row{
  display:flex;justify-content:space-between;align-items:center;
  border:1px solid var(--c4);border-radius:var(--radius);
  padding:0.5rem 0.75rem;margin-bottom:0.4rem;
  background:rgba(42,45,58,0.8);
}
.file-dl-name{font-size:0.82rem}
.file-dl-meta{font-size:0.72rem;color:var(--t2)}
.file-dl-btn{
  background:transparent;border:none;color:var(--lime);
  font-family:var(--mono);font-size:0.82rem;cursor:pointer;font-weight:600;
}
.file-dl-btn:hover{text-decoration:underline;color:var(--forest)}

/* â”€â”€ Links found â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.links-box{margin-top:1rem;font-size:0.78rem}
.links-box p{color:var(--t2);margin-bottom:0.4rem}
.links-box a{color:var(--lime);word-break:break-all;display:block;margin-bottom:0.2rem}
.links-box a:hover{color:var(--forest)}

/* â”€â”€ Share result card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.result-card{
  background:rgba(42,45,58,0.6);
  border:1px solid var(--c4);
  border-radius:4px;
  padding:1.5rem;
  box-shadow:0 4px 24px rgba(10,10,15,0.5);
}
.result-card h2{
  font-size:0.85rem;letter-spacing:0.1em;text-transform:uppercase;
  color:var(--lime);margin-bottom:1.2rem;
}
.result-actions{display:flex;gap:0.5rem;margin-top:1rem;flex-wrap:wrap}

/* â”€â”€ Loading spinner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.spinner{
  display:inline-block;width:14px;height:14px;
  border:2px solid var(--c5);border-top-color:var(--lime);
  border-radius:50%;animation:spin 0.7s linear infinite;
  vertical-align:middle;margin-left:0.4rem;
}
@keyframes spin{to{transform:rotate(360deg)}}

/* â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#toasts{
  position:fixed;bottom:1.5rem;right:1.5rem;
  display:flex;flex-direction:column-reverse;gap:0.5rem;
  z-index:1000;pointer-events:none;
}
.toast{
  background:var(--navy-mid);border:1px solid var(--c5);
  padding:0.5rem 1rem;font-size:0.78rem;border-radius:var(--radius);
  color:var(--t0);animation:toastIn 0.2s var(--ease);
  max-width:300px;
  box-shadow:0 4px 16px rgba(10,10,15,0.6);
}
.toast.ok{border-left:3px solid var(--lime)}
.toast.err{border-left:3px solid var(--red);color:#ffaaaa}
@keyframes toastIn{from{transform:translateX(1rem);opacity:0}to{transform:none;opacity:1}}

/* â”€â”€ Divider â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.divider{border:none;border-top:1px solid var(--c3);margin:1.5rem 0}

/* â”€â”€ Password prompt â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.pw-card{max-width:400px}
.pw-card p{font-size:0.82rem;color:var(--t1);margin-bottom:1.2rem}

/* â”€â”€ Accent highlight for code â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
code{color:var(--lime)}

/* â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media(max-width:500px){
  header{padding:1.5rem 0 1rem}
  .row-2{grid-template-columns:1fr}
}

/* â”€â”€ Page transitions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.page{animation:fadeIn 0.18s var(--ease)}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}

/* â”€â”€ Scrollbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:#22242f}
::-webkit-scrollbar-thumb{background:var(--c4);border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:var(--forest)}
</style>
</head>
<body>
<div id="root">
  <header>
    <div class="wrap">
      <div id="logoArea">
        <div class="logo-text">emerald <em>password share</em></div>
      </div>
    </div>
  </header>
  <main>
    <div class="wrap">
      <div id="app"><div style="color:var(--t2);font-size:0.82rem;padding-top:2rem">Loadingâ€¦<span class="spinner"></span></div></div>
    </div>
  </main>
  <footer>
    <div class="wrap">
      <span id="footerVer">Emerald Password Share</span>
    </div>
  </footer>
</div>
<div id="toasts"></div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UTILITIES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const $ = id => document.getElementById(id)

// Safe escape for HTML attribute/text contexts
function esc(s){
  return String(s)
    .replace(/&/g,'&amp;').replace(/</g,'&lt;')
    .replace(/>/g,'&gt;').replace(/"/g,'&quot;')
}

// Safe text node setter â€” never uses innerHTML with untrusted content
function setText(el, text){ if(el) el.textContent = text }

function render(content){
  const app = $('app')
  app.innerHTML = ''
  if(typeof content === 'string'){
    app.innerHTML = content
  } else {
    app.appendChild(content)
  }
}

function fmtBytes(b){
  if(b < 1024) return b + ' B'
  if(b < 1048576) return (b/1024).toFixed(1) + ' KB'
  return (b/1048576).toFixed(1) + ' MB'
}

function toast(msg, type='ok'){
  const wrap = $('toasts')
  const el = document.createElement('div')
  el.className = `toast ${type}`
  el.textContent = msg          // textContent â€” no XSS risk
  wrap.appendChild(el)
  setTimeout(()=>{ el.style.transition='opacity 0.3s'; el.style.opacity='0'; setTimeout(()=>el.remove(),320) }, 3200)
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CRYPTO  (WebCrypto AES-GCM-256 + PBKDF2)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const toHex = buf => Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('')
const fromHex = str => new Uint8Array((str.match(/.{2}/g)||[]).map(h=>parseInt(h,16)))

async function genKey(){
  return crypto.subtle.generateKey({name:'AES-GCM',length:256},true,['encrypt','decrypt'])
}
async function exportKeyHex(k){ return toHex(await crypto.subtle.exportKey('raw',k)) }
async function importKeyHex(hex, usage=['decrypt']){
  return crypto.subtle.importKey('raw',fromHex(hex),{name:'AES-GCM'},false,usage)
}
async function deriveKey(password, saltHex){
  const enc = new TextEncoder()
  const salt = saltHex ? fromHex(saltHex) : crypto.getRandomValues(new Uint8Array(16))
  const base = await crypto.subtle.importKey('raw',enc.encode(password),{name:'PBKDF2'},false,['deriveKey'])
  const key  = await crypto.subtle.deriveKey(
    {name:'PBKDF2',salt,iterations:200000,hash:'SHA-256'},
    base,{name:'AES-GCM',length:256},false,['encrypt','decrypt']
  )
  return {key, saltHex: toHex(salt)}
}
async function encrypt(plainBytes, key){
  const iv = crypto.getRandomValues(new Uint8Array(12))
  const ct = await crypto.subtle.encrypt({name:'AES-GCM',iv},key,plainBytes)
  return toHex(iv) + toHex(ct)
}
async function encryptText(text, key){ return encrypt(new TextEncoder().encode(text), key) }
async function encryptFiles(files, key){
  const data = await Promise.all(files.map(async f=>{
    const buf = await f.arrayBuffer()
    return {name:f.name,size:f.size,type:f.type||'application/octet-stream',contents:Array.from(new Uint8Array(buf))}
  }))
  return encryptText(JSON.stringify(data), key)
}
async function decryptToText(hexStr, key){
  const b = fromHex(hexStr)
  const pt = await crypto.subtle.decrypt({name:'AES-GCM',iv:b.slice(0,12)},key,b.slice(12))
  return new TextDecoder().decode(pt)
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CLIPBOARD  (with fallback for non-HTTPS / permission-denied)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function copyToClipboard(text){
  // Modern async API
  if(navigator.clipboard && window.isSecureContext){
    try{
      await navigator.clipboard.writeText(text)
      toast('Copied to clipboard','ok')
      return
    } catch(_){}
  }
  // Fallback: create a temporary textarea and use execCommand
  try{
    const ta = document.createElement('textarea')
    ta.value = text
    ta.style.cssText = 'position:fixed;opacity:0;pointer-events:none'
    document.body.appendChild(ta)
    ta.focus(); ta.select()
    document.execCommand('copy')
    document.body.removeChild(ta)
    toast('Copied to clipboard','ok')
  } catch(_){
    toast('Could not copy â€” please copy manually','err')
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   API
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function apiGet(path){
  const r = await fetch(path)
  if(!r.ok) throw Object.assign(new Error('api'),{status:r.status})
  return r.json()
}
async function apiPost(path, body){
  const r = await fetch(path,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)})
  if(!r.ok) throw Object.assign(new Error('api'),{status:r.status})
  return r.json()
}
async function apiDelete(path){
  const r = await fetch(path,{method:'DELETE'})
  if(!r.ok) throw Object.assign(new Error('api'),{status:r.status})
  return r.json()
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PRIVATE STATE  (not on window â€” closure-scoped to avoid leaking
   decrypted content to the global scope / browser console)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const _private = (() => {
  let _plaintext = null
  let _decFiles  = null
  return {
    setPlaintext(v){ _plaintext = v },
    getPlaintext(){ return _plaintext },
    setDecFiles(v){ _decFiles = v },
    getDecFiles(){ return _decFiles },
    clear(){ _plaintext = null; _decFiles = null },
  }
})()

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ROUTER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let _status = null

async function boot(){
  try{ _status = await apiGet('/api/status') }catch{}
  applyTheme(_status)
  const m = location.pathname.match(/^\/note\/([A-Za-z0-9_-]+)\/?$/)
  if(m) await pageNote(m[1])
  else   await pageHome()
}

function applyTheme(s){
  if(!s) return
  if(s.theme_page_title) document.title = esc(s.theme_page_title)
  if(s.theme_favicon){
    let l = document.querySelector("link[rel~='icon']")||document.createElement('link')
    l.rel='icon'; l.href=esc(s.theme_favicon); document.head.appendChild(l)
  }
  if(s.theme_image){
    // Build DOM node instead of innerHTML to avoid XSS via theme_image URL
    const a   = document.createElement('a'); a.href = '/'
    const img = document.createElement('img')
    img.className = 'logo-img'
    img.src = s.theme_image   // browser sanitises this natively
    img.alt = 'Logo'
    a.appendChild(img)
    $('logoArea').innerHTML = ''
    $('logoArea').appendChild(a)
  }
  // theme_text is operator-controlled HTML â€” render it, but note in docs
  // that operators must treat it as trusted input.
  if(s.theme_text){
    // Intentionally rendered as HTML â€” operator-controlled only, not user data
    const introEl = document.getElementById('themeIntro')
    if(introEl) introEl.innerHTML = s.theme_text
  }
  const ver = $('footerVer')
  if(ver) ver.textContent = `Emerald Password Share v${s.version||''}`
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HOME PAGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const _home = {
  mode: 'text',
  advanced: false,
  timeMode: false,
  files: [],
  busy: false,
}

async function pageHome(){
  const s = _status
  const maxMB = s ? fmtBytes(s.max_size) : '80 MB'
  const allowAdv  = s ? s.allow_advanced : true
  const allowFile = s ? s.allow_files    : true
  const defaultIntro = 'Easily send <span style="color:var(--lime)">fully encrypted</span> notes and files. The link is the key â€” share it once.'

  render(`<div class="page">
    <p id="themeIntro" style="font-size:0.82rem;color:var(--t1);margin-bottom:1.5rem;line-height:1.6">${defaultIntro}</p>

    ${allowFile ? `
    <div class="mode-toggle">
      <button class="mode-btn ${_home.mode==='text'?'active':''}" id="btnModeText" onclick="setMode('text')">Text</button>
      <button class="mode-btn ${_home.mode==='file'?'active':''}" id="btnModeFile" onclick="setMode('file')">File</button>
    </div>` : ''}

    <div id="inputArea"></div>

    <div class="bottom-bar">
      <div class="bottom-bar-left">
        ${allowAdv ? `<label class="toggle-row" onclick="toggleAdvanced()">
          <div id="advSW" class="sw${_home.advanced?' on':''}"></div>
          Advanced
        </label>` : ''}
        <span class="max-label">Max ${maxMB}</span>
      </div>
      <button class="btn-primary" id="submitBtn" onclick="handleCreate()" ${_home.busy?'disabled':''}>
        Create note
      </button>
    </div>

    <p class="status-msg" id="statusMsg">${describeExpiry()}</p>

    ${allowAdv ? `
    <div class="advanced${_home.advanced?' open':''}" id="advPanel">
      <div class="row-2">
        <div class="field">
          <span class="label" id="limitLabel">${_home.timeMode?'Minutes':'Views'}</span>
          <input type="number" id="limitVal" value="${_home.timeMode?60:1}" min="1"
            max="${_home.timeMode?(s?.max_expiration||360):(s?.max_views||100)}"
            oninput="updateStatus()"/>
        </div>
        <div class="field" style="display:flex;align-items:flex-end;padding-bottom:0.1rem">
          <label class="toggle-row" onclick="toggleTimeMode()">
            <div id="timeSW" class="sw${_home.timeMode?' on':''}"></div>
            Time-based
          </label>
        </div>
      </div>
      <div class="field">
        <span class="label">Custom password <span style="color:var(--t2);font-size:0.65rem">(optional â€” not in link)</span></span>
        <input type="password" id="customPw" placeholder="Leave blank for auto-generated key"/>
      </div>
      <p class="hint">Custom passwords are never included in the share link. The recipient will need it separately.</p>
    </div>` : ''}

    <p class="hint" style="margin-top:1.2rem">
      ğŸ”’ Notes are encrypted in your browser before being sent. The server never sees the contents.
      The share link contains the decryption key in the <code>#fragment</code>,
      which is never sent to the server. Avoid forwarding the full link over insecure channels.
    </p>
  </div>`)

  // Apply theme_text after render so the element exists
  if(_status?.theme_text){
    const el = document.getElementById('themeIntro')
    if(el) el.innerHTML = _status.theme_text
  }

  renderInputArea()
}

function renderInputArea(){
  const area = $('inputArea')
  if(!area) return
  if(_home.mode === 'text'){
    area.innerHTML = `<div class="field">
      <span class="label">Note</span>
      <textarea id="noteText" placeholder="Type your secure note hereâ€¦"></textarea>
    </div>`
  } else {
    area.innerHTML = `<div class="field">
      <span class="label">Files</span>
      <div class="dropzone" id="dropzone"
        onclick="$('fileInput').click()"
        ondragover="onDragOver(event)"
        ondragleave="onDragLeave(event)"
        ondrop="onDrop(event)">
        <input type="file" id="fileInput" multiple style="display:none" onchange="onFileChange(event)"/>
        <div id="dropContent">
          <div class="dropzone-icon">â¬†</div>
          <div class="dropzone-label">Click or drag files here</div>
        </div>
      </div>
    </div>`
    renderFileList()
  }
}

function renderFileList(){
  const c = $('dropContent')
  if(!c) return
  if(_home.files.length === 0){
    c.innerHTML = `<div class="dropzone-icon">â¬†</div><div class="dropzone-label">Click or drag files here</div>`
  } else {
    c.innerHTML = `<ul class="file-list">${
      _home.files.map((f,i)=>`<li>
        <span>${esc(f.name)}</span>
        <span>${fmtBytes(f.size)} <button onclick="removeFile(event,${i})" style="background:none;border:none;color:var(--red);cursor:pointer;font-size:0.9rem;padding:0 0 0 0.3rem">Ã—</button></span>
      </li>`).join('')
    }</ul>
    <div class="dropzone-label" style="margin-top:0.5rem;font-size:0.72rem">Click to add more</div>`
  }
}

function setMode(mode){
  _home.mode = mode
  _home.files = []
  document.querySelectorAll('.mode-btn').forEach(b=>b.classList.remove('active'))
  $(`btnMode${mode==='text'?'Text':'File'}`)?.classList.add('active')
  renderInputArea()
}

function onDragOver(e){ e.preventDefault(); $('dropzone')?.classList.add('dragover') }
function onDragLeave(){ $('dropzone')?.classList.remove('dragover') }
function onDrop(e){
  e.preventDefault(); $('dropzone')?.classList.remove('dragover')
  _home.files.push(...Array.from(e.dataTransfer.files))
  renderFileList()
}
function onFileChange(e){ _home.files.push(...Array.from(e.target.files)); renderFileList() }
function removeFile(e,i){ e.stopPropagation(); _home.files.splice(i,1); renderFileList() }

function toggleAdvanced(){
  _home.advanced = !_home.advanced
  const sw = $('advSW')
  if(sw) sw.classList.toggle('on', _home.advanced)
  const panel = $('advPanel')
  if(panel) panel.classList.toggle('open', _home.advanced)
  if(!_home.advanced){ _home.timeMode=false; updateStatus() }
}

function toggleTimeMode(){
  _home.timeMode = !_home.timeMode
  const sw = $('timeSW'); if(sw) sw.classList.toggle('on',_home.timeMode)
  const lbl = $('limitLabel'); if(lbl) lbl.textContent=_home.timeMode?'Minutes':'Views'
  const inp = $('limitVal'); if(inp){ inp.value=_home.timeMode?60:1; inp.max=_home.timeMode?(_status?.max_expiration||360):(_status?.max_views||100) }
  updateStatus()
}

function describeExpiry(){
  if(!_home.advanced) return 'Note will self-destruct after 1 view.'
  const v = $('limitVal')?.value || 1
  if(_home.timeMode) return `Note will self-destruct after ${v} minute${v==1?'':'s'}.`
  return `Note will self-destruct after ${v} view${v==1?'':'s'}.`
}

function updateStatus(){
  const el = $('statusMsg'); if(el && !_home.busy) el.textContent = describeExpiry()
}

function setBusy(msg){
  _home.busy = true
  const btn = $('submitBtn')
  if(btn){
    btn.disabled = true
    btn.textContent = msg
    const sp = document.createElement('span'); sp.className='spinner'
    btn.appendChild(sp)
  }
  const sm = $('statusMsg')
  if(sm){
    sm.textContent = msg
    const sp = document.createElement('span'); sp.className='spinner'
    sm.appendChild(sp)
  }
}

async function handleCreate(){
  if(_home.busy) return
  setBusy('Encrypting')

  try{
    const pw = $('customPw')?.value.trim() || ''
    let key, derivation

    if(pw){
      const d = await deriveKey(pw, null)
      key=d.key; derivation=d.saltHex
    } else {
      key = await genKey()
    }

    let contents, type
    if(_home.mode === 'file'){
      if(_home.files.length === 0){ toast('No files selected','err'); _home.busy=false; await pageHome(); return }
      contents = await encryptFiles(_home.files, key)
      type = 'file'
    } else {
      const txt = $('noteText')?.value || ''
      if(!txt.trim()){ toast('Note is empty','err'); _home.busy=false; await pageHome(); return }
      contents = await encryptText(txt, key)
      type = 'text'
    }

    const meta = {type}
    if(derivation) meta.derivation = derivation

    const limitVal = parseInt($('limitVal')?.value||'1') || 1
    const payload = {contents, meta: JSON.stringify(meta)}
    if(_home.advanced && _home.timeMode) payload.expiration = limitVal
    else payload.views = _home.advanced ? limitVal : 1

    setBusy('Uploading')
    const resp = await apiPost('/api/notes', payload)
    const keyHex = pw ? null : await exportKeyHex(key)
    const url = `${location.origin}/note/${resp.id}${keyHex?'#'+keyHex:''}`

    toast('Note created successfully','ok')
    pageResult(url, pw)
  } catch(err){
    if(err.status===413) toast('Note is too large','err')
    else if(err.status===429) toast('Too many requests â€” please wait a moment','err')
    else toast('Failed to create note. Please try again.','err')
    console.error(err)
    _home.busy = false
    await pageHome()
  }
}

function pageResult(url, hasCustomPw){
  const mailto = `mailto:?subject=${encodeURIComponent('Shared secure note')}&body=${encodeURIComponent(url)}`
  render(`<div class="page">
    <div class="result-card">
      <h2>Note created</h2>
      <div class="field">
        <span class="label">Share link</span>
        <div class="input-row">
          <input type="text" id="shareUrl" readonly value="${esc(url)}"/>
          <button class="btn-icon" onclick="copyShareUrl()">Copy</button>
        </div>
      </div>
      ${hasCustomPw ? `<p class="hint" style="margin-top:0.5rem">âš  Password is required to open this note â€” share it separately.</p>` : ''}
      <div class="info-box" style="margin-top:0.8rem">
        âš  The link contains the decryption key. Anyone with the link can read the note â€” treat it like a password.
      </div>
      <div class="result-actions">
        <a href="${esc(mailto)}" style="text-decoration:none">
          <button class="btn-outline">âœ‰ Send via email</button>
        </a>
        <button class="btn-ghost" onclick="startOver()">New note</button>
      </div>
    </div>
  </div>`)
}

function copyShareUrl(){
  const url = $('shareUrl')?.value || ''
  copyToClipboard(url)
}

function startOver(){
  _home.mode='text'; _home.advanced=false; _home.timeMode=false; _home.files=[]; _home.busy=false
  _private.clear()
  pageHome()
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NOTE VIEW PAGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function pageNote(id){
  const hashKey = location.hash.slice(1)

  render(`<div style="color:var(--t2);font-size:0.82rem;padding-top:1rem">Checkingâ€¦<span class="spinner"></span></div>`)

  let meta
  try{
    const info = await apiGet(`/api/notes/${id}`)
    meta = JSON.parse(info.meta || '{}')
  } catch(e){
    const msg = e.status === 429
      ? 'Too many requests â€” please wait a moment and try again.'
      : 'This note was not found, has already been viewed, or has expired.'
    render(`<div class="page">
      <p style="color:var(--red);margin-bottom:1rem">${esc(msg)}</p>
      <a href="/"><button class="btn-ghost">â† Create a new note</button></a>
    </div>`)
    return
  }

  if(meta.derivation){
    renderPasswordPrompt(id, meta)
  } else if(hashKey){
    renderRevealButton(id, meta, hashKey)
  } else {
    render(`<div class="page">
      <p style="color:var(--red);margin-bottom:1rem">Decryption key missing â€” the link may be incomplete.</p>
      <a href="/"><button class="btn-ghost">â† Create a new note</button></a>
    </div>`)
  }
}

// Store note meta in a module-scoped variable, not on window
let _pendingNoteMeta = null

function renderRevealButton(id, meta, hashKey){
  _pendingNoteMeta = meta
  const isFile = meta.type === 'file'
  render(`<div class="page">
    <p style="font-size:0.82rem;color:var(--t1);margin-bottom:1.5rem">
      This note will be permanently deleted once you reveal it.<br/>
      <strong style="color:var(--t0)">You will not be able to see it again.</strong>
    </p>
    ${isFile ? `<div class="info-box">
      â¬‡ This note contains <strong>files</strong>. Make sure you are ready to download them before proceeding â€”
      they cannot be retrieved after this page is closed.
    </div>` : ''}
    <button class="btn-primary" id="revealBtn" onclick="revealNote('${esc(id)}',null,'${esc(hashKey)}')">Reveal note</button>
    <p id="revealErr" class="error" style="display:none"></p>
  </div>`)
}

function renderPasswordPrompt(id, meta){
  _pendingNoteMeta = meta
  render(`<div class="page pw-card">
    <p>This note is protected with a custom password.<br/>Enter it below to decrypt and reveal the note.</p>
    <div class="field">
      <span class="label">Password</span>
      <input type="password" id="pwInput" placeholder="Enter passwordâ€¦"
        onkeydown="if(event.key==='Enter') revealNote('${esc(id)}','pw',null)"/>
    </div>
    <button class="btn-primary" id="revealBtn" onclick="revealNote('${esc(id)}','pw',null)">Reveal note</button>
    <p id="revealErr" class="error" style="display:none"></p>
  </div>`)
}

async function revealNote(id, pwMode, hashKey){
  const btn = $('revealBtn'); if(!btn) return
  const errEl = $('revealErr')
  btn.disabled=true
  btn.textContent='Decrypting'
  const sp = document.createElement('span'); sp.className='spinner'; btn.appendChild(sp)
  if(errEl) errEl.style.display='none'

  try{
    const data = await apiDelete(`/api/notes/${id}`)
    const meta = _pendingNoteMeta || {}
    let key

    if(pwMode === 'pw'){
      const pw = $('pwInput')?.value
      if(!pw){ throw Object.assign(new Error('No password')) }
      const d = await deriveKey(pw, meta.derivation)
      key = d.key
    } else {
      key = await importKeyHex(hashKey)
    }

    const plaintext = await decryptToText(data.contents, key)

    if(meta.type === 'file'){
      renderDecryptedFiles(JSON.parse(plaintext))
    } else {
      renderDecryptedText(plaintext)
    }
  } catch(e){
    let msg
    if(e.status === 404)      msg = 'Note not found â€” it may have already been viewed.'
    else if(e.status === 429) msg = 'Too many requests â€” please wait a moment.'
    else                      msg = 'Decryption failed. Wrong password or broken link.'
    if(errEl){ errEl.textContent=msg; errEl.style.display='block' }
    if(btn){ btn.disabled=false; btn.textContent='Try again' }
  }
}

function renderDecryptedText(text){
  const urlRe = /[A-Za-z][A-Za-z0-9+\-.]*:\/\/[^\s<>"']+/g
  const links  = [...new Set(text.match(urlRe)||[])]

  // Store in private closure, not on window
  _private.setPlaintext(text)

  // Build the note box safely using a text node
  const noteBox = document.createElement('div')
  noteBox.className = 'note-box'
  noteBox.textContent = text   // safe â€” no innerHTML

  const container = document.createElement('div')
  container.className = 'page'

  // Warning banner
  const warn = document.createElement('div')
  warn.className = 'warning'
  warn.innerHTML = 'âš  <strong>This is your one chance</strong> to read this note. It has been permanently deleted.'
  container.appendChild(warn)
  container.appendChild(noteBox)

  // Action buttons row
  const btnRow = document.createElement('div')
  btnRow.style.cssText = 'display:flex;gap:0.5rem;flex-wrap:wrap;margin-bottom:1rem'
  const copyBtn = document.createElement('button')
  copyBtn.className = 'btn-outline'
  copyBtn.textContent = 'Copy to clipboard'
  copyBtn.onclick = copyPlaintext
  const newBtn = document.createElement('a')
  newBtn.href = '/'
  newBtn.innerHTML = '<button class="btn-ghost">â† New note</button>'
  btnRow.appendChild(copyBtn)
  btnRow.appendChild(newBtn)
  container.appendChild(btnRow)

  // Links found
  if(links.length){
    const linksBox = document.createElement('div')
    linksBox.className = 'links-box'
    const p = document.createElement('p')
    p.textContent = 'Links found in this note:'
    linksBox.appendChild(p)
    links.forEach(l=>{
      const a = document.createElement('a')
      a.href = l
      a.target = '_blank'
      a.rel = 'noopener noreferrer'
      a.textContent = l   // textContent â€” safe
      linksBox.appendChild(a)
    })
    container.appendChild(linksBox)
  }

  render(container)
}

function copyPlaintext(){
  copyToClipboard(_private.getPlaintext() || '')
}

function renderDecryptedFiles(files){
  // Store in private closure, not on window
  _private.setDecFiles(files)

  render(`<div class="page">
    <div class="warning">âš  <strong>This is your one chance</strong> to download these files. They have been permanently deleted.</div>
    <div class="info-box">Save all files before navigating away â€” they cannot be recovered.</div>
    ${files.map((f,i)=>`
      <div class="file-dl-row">
        <div>
          <div class="file-dl-name">${esc(f.name)}</div>
          <div class="file-dl-meta">${esc(f.type)} Â· ${fmtBytes(f.size)}</div>
        </div>
        <button class="file-dl-btn" onclick="dlFile(${i})">â†“ Download</button>
      </div>`).join('')}
    <div style="display:flex;gap:0.5rem;flex-wrap:wrap;margin-top:0.8rem">
      <button class="btn-outline" onclick="dlAll()">â†“ Download all</button>
      <a href="/"><button class="btn-ghost">â† New note</button></a>
    </div>
  </div>`)
}

function dlFile(i){
  const files = _private.getDecFiles()
  if(!files) return
  const f = files[i]
  const blob = new Blob([new Uint8Array(f.contents)],{type:f.type||'application/octet-stream'})
  const a = Object.assign(document.createElement('a'),{href:URL.createObjectURL(blob),download:f.name})
  a.click(); URL.revokeObjectURL(a.href)
}

function dlAll(){
  const files = _private.getDecFiles()
  if(files) files.forEach((_,i)=>dlFile(i))
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BOOT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
boot().catch(console.error)
</script>
</body>
</html>
